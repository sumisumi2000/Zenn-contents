---
title: "ブロック付きメソッドにシンボルを渡す"
emoji: "🐥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Ruby"]
published: false
---

# はじめに
```rb
["abc", "123"].map(&:reverse)
```
Rubyではブロック付きメソッドにシンボルを渡すことができるみたい。
メソッドにシンボルを渡すときの処理が気になり、調べた結果をまとめておく。

# ブロック付きメソッドとは
> ブロック付きメソッドとは制御構造の抽象化のために用いられるメソッドです。（中略） do ... end または { ... } で囲まれたコードの断片 (ブロックと呼ばれる)を後ろに付けてメソッドを呼び出すと、そのメソッドの内部からブロックを評価できます
>
>  メソッド呼び出し(super・ブロック付き・yield) (Ruby 3.1 リファレンスマニュアル)

+ メソッドには**ブロック**を渡せるものがあり、この**ブロックが付随したメソッド**のことを**ブロック付きメソッド**という。
+ **ブロック**とは`do` ~ `end` や `{`~`}`で囲まれている処理のかたまりを表すもの。
+ `each`メソッドや`map`メソッドはブロックを受け取ることができるメソッドである。

### 記述方法
```rb:sample.rb
# do end を用いた書き方
result = ["abc", "123"].map do |text|
    text.reverse
end
p result

# {} を用いた書き方
p ["abc", "123"].map {|text| text.reverse}

# シンボルを用いた書き方
p ["abc", "123"].map(&:reverse)
```
##### 出力
```bash
ruby sample.rb
# 上記の3つの書き方は同じ出力になる
["cba", "321"]
["cba", "321"]
["cba", "321"]
```
+ 上二つはブロックを渡しているが一番下は**シンボル**[^1]に`&`をつけて渡している。

# ブロック付きメソッドに渡せるもの
> to_proc メソッドを持つオブジェクトならば、`&' 修飾した引数として渡すことができます。（中略）to_proc はメソッド呼び出し時に実行され、Proc オブジェクトを返すことが期待されます。
>
>  メソッド呼び出し(super・ブロック付き・yield) (Ruby 3.1 リファレンスマニュアル)

+ つまり、ブロック付きメソッドには`to_proc`メソッドを持つオブジェクトを渡すことが可能である。
+ そして、`Symbol`クラスは`to_proc`メソッドを持つので、`map`メソッドには`&:reverse`として渡すことができる。

https://docs.ruby-lang.org/ja/3.1/class/Symbol.html#I_TO_PROC

# ["abc", "123"].map(&:reverse)の処理
1. `map`メソッド呼び出し時に、引数であるシンボルオブジェクト`:reverse`の`to_proc`メソッドが実行(`:reverse.to_proc`)される。
2. `:reverse.to_proc`を実行すると`:reverse`の[`Proc`オブジェクトが返り値](https://docs.ruby-lang.org/ja/3.1/class/Symbol.html#I_TO_PROC)となる。そして、得られた`Proc`オブジェクトを`map`メソッドの引数として渡す。
3. `map`メソッドは配列の各要素に対して引数の`Proc`オブジェクトを呼び出す。
4. `Proc`オブジェクトを呼び出す（`Proc#call`）と、`Proc#call`の第一引数をレシーバ[^2]として、 自身の名前のメソッドを呼び出す。
5. つまり、各要素をレシーバとして、`reverse`メソッドを呼び出している。

[^1]: シンボルとは任意の文字列と一対一に対応するオブジェクトである。<br> :symbolのようなリテラルで得られる。
[^2]: レシーバとはメソッドを呼び出されるオブジェクトのことである。